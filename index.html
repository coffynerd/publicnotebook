<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udostępniona Notatka</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        :root {
            --background-light: #f0f2f5;
            --background-dark: #121212;
            --text-light: #1c1c1c;
            --text-dark: #e0e0e0;
            --surface-light: #fff;
            --surface-dark: #1e1e1e;
            --border-light: #ddd;
            --border-dark: #333;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--surface-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .dark-mode .container {
            background-color: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }
        header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark-mode header {
            border-bottom-color: var(--border-dark);
        }
        #note-title {
            margin: 0;
            font-size: 2em;
        }
        main {
            padding: 20px;
            line-height: 1.6;
        }
        #note-content div {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        #note-content input[type="checkbox"] {
            margin-right: 12px;
            flex-shrink: 0;
            width: 1.2em;
            height: 1.2em;
            cursor: pointer;
        }
        #note-content button {
            cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; transition: background-color 0.3s;
        }
        #theme-toggle-btn {
            font-size: 1.5em;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            color: var(--text-light);
        }
        .dark-mode #theme-toggle-btn {
            color: var(--text-dark);
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: var(--surface-light); color: var(--text-light); padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .dark-mode .modal-content { background: var(--surface-dark); color: var(--text-dark); }
    </style>
</head>
<body>
    <div id="modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h4 id="modal-title"></h4>
            <p id="modal-text"></p>
            <button id="modal-close-btn">Zamknij</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1 id="note-title">Ładowanie notatki...</h1>
            <button id="theme-toggle-btn" title="Zmień motyw"></button>
        </header>
        <main>
            <div id="note-content"><p>Pobieranie treści...</p></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const firebaseConfig = firebaseConfigFromEnv || {
            apiKey: "AIzaSyDT2h4LtrlLP0d2X4jWyaQKabzUbpK_elA",
            authDomain: "psb-app-58090.firebaseapp.com",
            projectId: "psb-app-58090",
            storageBucket: "psb-app-58090.appspot.com",
            messagingSenderId: "100516614463",
            appId: "1:100516614463:web:36fe37ee48cee575b8838a"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INIT ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch(e) {
            console.error("Firebase init failed", e);
            document.body.innerHTML = '<h1>Błąd inicjalizacji bazy danych.</h1>';
        }

        // --- GLOBAL STATE ---
        let currentNote = null;
        let noteId = '';

        // --- UI UTILITIES ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        document.getElementById('modal-close-btn').onclick = () => modal.style.display = 'none';

        function showModal(title, text) {
            modalTitle.textContent = title;
            modalText.textContent = text;
            modal.style.display = 'flex';
        }

        // --- NOTE HELPERS ---
        function convertTextToHtml(text) {
            if (!text) return '';
            const buttonRegex = /\[(.*?)\]\{(.*?)\}/g;
            const htmlBlockRegex = /\(html\)\{([\s\S]*?)\}\(html\)/g;

            const parts = text.split(htmlBlockRegex);

            const processedParts = parts.map((part, index) => {
                if (index % 2 === 1) { // This is the captured HTML content
                    return `<div class="raw-html-block">${part}</div>`;
                } else { // This is regular text
                    return part.split('\n').map(line => {
                        const trimmed = line.trim();
                        if (trimmed.startsWith('# ')) {
                            const content = trimmed.substring(2).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            return `<div><input type="checkbox">${content}</div>`;
                        }
                        if (trimmed.startsWith('& ')) {
                            const content = trimmed.substring(2).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            return `<div><input type="checkbox" checked>${content}</div>`;
                        }
                        
                        let processedLine = line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        processedLine = processedLine.replace(buttonRegex, (match, buttonText, link) => {
                            let href = link.trim();
                            if (!href.startsWith('http://') && !href.startsWith('https://')) {
                                href = 'https://' + href;
                            }
                            const unescapedButtonText = buttonText.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                            return `<a href="${href}" target="_blank"><button>${unescapedButtonText}</button></a>`;
                        });
                        
                        return `<div>${processedLine}</div>`;
                    }).join('');
                }
            });

            return processedParts.join('');
        }

        function convertRenderedToSource(element) {
            const lines = [];
            element.childNodes.forEach(child => {
                if (child.nodeName !== 'DIV') {
                    if (child.textContent.trim()) lines.push(child.textContent);
                    return;
                }
                if (child.classList.contains('raw-html-block')) {
                    lines.push(`(html){${child.innerHTML}}(html)`);
                    return;
                }

                const checkbox = child.querySelector('input[type="checkbox"]');
                const link = child.querySelector('a');
                const button = link ? link.querySelector('button') : null;

                if (checkbox) {
                    const prefix = checkbox.checked ? '& ' : '# ';
                    lines.push(prefix + child.textContent.trim());
                } else if (link && button) {
                    const buttonText = button.textContent;
                    let href = link.getAttribute('href');
                    if (href.startsWith('https://')) href = href.substring(8);
                    else if (href.startsWith('http://')) href = href.substring(7);
                    lines.push(`[${buttonText}]{${href}}`);
                } else {
                    lines.push(child.textContent);
                }
            });
            return lines.join('\n');
        }
        
        // --- CORE LOGIC ---
        async function fetchAndRenderNote() {
            const urlParams = new URLSearchParams(window.location.search);
            noteId = urlParams.get('uuid') || urlParams.get('id');
            
            const titleEl = document.getElementById('note-title');
            const contentEl = document.getElementById('note-content');

            if (!noteId) {
                titleEl.textContent = 'Błąd';
                contentEl.innerHTML = '<p>Nie znaleziono identyfikatora notatki w adresie URL.</p>';
                return;
            }

            if(!db) {
                titleEl.textContent = 'Błąd';
                contentEl.innerHTML = '<p>Błąd połączenia z bazą danych.</p>';
                return;
            }

            let docSnap;
            // Try fetching by ID first (new Firebase notes)
            const docRefById = doc(db, `artifacts/${appId}/public/data/notes`, noteId);
            docSnap = await getDoc(docRefById);

            // If not found by ID, try fetching by UUID (old Supabase notes migrated to Firebase)
            if (!docSnap.exists()) {
                const q = query(collection(db, `artifacts/${appId}/public/data/notes`), where("uuid", "==", noteId));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    docSnap = querySnapshot.docs[0];
                }
            }
            
            if (docSnap && docSnap.exists() && (docSnap.data().public || docSnap.data().is_public)) {
                currentNote = { id: docSnap.id, ...docSnap.data(), source: 'firebase' };
                titleEl.textContent = currentNote.title;
                titleEl.style.color = currentNote.titleColor || 'inherit';
                document.title = currentNote.title;
                contentEl.innerHTML = convertTextToHtml(currentNote.content);
                return;
            }

            // If not found in Firebase at all
            titleEl.textContent = 'Brak dostępu';
            contentEl.innerHTML = '<p>Notatka nie została znaleziona lub nie jest publiczna.</p>';
        }

        async function handleCheckboxChange(e) {
            if (!currentNote || (e.target.tagName !== 'INPUT' || e.target.type !== 'checkbox')) {
                return;
            }

            const newContent = convertRenderedToSource(document.getElementById('note-content'));
            const oldContent = currentNote.content;
            currentNote.content = newContent; // Optimistic update

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/notes`, currentNote.id);
                await updateDoc(docRef, {
                    content: newContent,
                    updatedAt: new Date()
                });
            } catch (error) {
                currentNote.content = oldContent; // Revert on failure
                e.target.checked = !e.target.checked;
                showModal('Błąd', 'Nie udało się zapisać zmiany.');
                console.error('Error updating note:', error);
            }
        }

        // --- THEME ---
        function updateThemeIcon() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.getElementById('theme-toggle-btn').innerHTML = isDarkMode ? '&#9728;&#65039;' : '&#127769;';
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('publicNoteTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            updateThemeIcon();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('publicNoteTheme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
            updateThemeIcon();
            
            document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
            document.getElementById('note-content').addEventListener('change', handleCheckboxChange);
             document.getElementById('note-content').addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.href) {
                    e.preventDefault();
                    window.open(link.href, '_blank');
                }
            });
            
            fetchAndRenderNote();
        });

    </script>
</body>
</html>

